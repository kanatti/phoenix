# Iceberg Hands on

Trying out what iceberg can do.

Start:
```
docker-compose up -d
docker exec -it spark-iceberg pyspark-notebook
```

Stop:
```
docker-compose down
```

This gives:
- Notebook server on `localhost:8888`.
- Spark Driver UI on `localhost:8080`.

Compose spins up for containers:
1. spark-iceberg
2. iceberg-rest
3. minio
4. mc


## Inspecting artifacts

With volumes setup, artifacts generated by iceberg are available outside the container for inspection.

1. `./minio-raw` -> contains all minio raw data (erasure encoded parquet data files, manifests, manifest lists).
2. `./minio-data` -> volume tied to `mc` (as `/data`) to copy minio data into actual format.
3. `./catalog` -> contains sqllite DB created by `iceberg-rest`.

Resolution of parquet data is of following order

```
┌──────────────────┐              
│                  │              
│    Table entry   │   --- Catalog
│                  │              
└────────│─────────┘              
         │                        
         │                        
         ▼                        
┌──────────────────┐              
│                  │              
│   metadata.json  │   --- Storage
│                  │              
└────────│─────────┘              
         │                        
         ▼                        
┌──────────────────┐              
│                  │              
│   snapshot-id    │   --- Storage
│                  │              
└────────│─────────┘              
         │                        
         ▼                        
┌──────────────────┐              
│                  │              
│manifest-list.avro│   --- Storage
│                  │              
└────────│─────────┘              
         │                        
         │                        
         ▼                        
┌──────────────────┐              
│                  │              
│  manifest.avro   │   --- Storage
│                  │              
└────────│─────────┘              
         │                        
         │                        
         ▼                        
┌──────────────────┐              
│                  │              
│    data.parquet  │  --- Storage 
│                  │              
└──────────────────┘              
```

### Sqlite Catalog

```sh
sqlite3 ./catalog/test.db
```


```
sqlite> .headers on
sqlite> .tables
iceberg_namespace_properties  iceberg_tables
sqlite> .mode box
sqlite> select * from iceberg_namespace_properties ;
┌──────────────┬───────────┬──────────────┬────────────────┐
│ catalog_name │ namespace │ property_key │ property_value │
├──────────────┼───────────┼──────────────┼────────────────┤
│ rest_backend │ nyc       │ owner        │ root           │
│ rest_backend │ nyc       │ exists       │ true           │
└──────────────┴───────────┴──────────────┴────────────────┘
sqlite> .mode line
sqlite> select * from iceberg_tables;
              catalog_name = rest_backend
           table_namespace = nyc
                table_name = taxis
         metadata_location = s3://warehouse/nyc/taxis/metadata/00000-f48245c1-6286-4db0-a99a-71d3ad588d18.metadata.json
previous_metadata_location =
              iceberg_type = TABLE
```


### Minio files

```
❯ cd ./minio-raw
❯ tree
.
└── warehouse
    └── nyc
        └── taxis
            ├── data
            │   └── 00001-2-ea79ee2d-93f4-479e-97ba-d143cc40dbe1-0-00001.parquet
            │       ├── d9dcc96b-569f-4fc0-8d42-3f4d70ea1da0
            │       │   └── part.1
            │       └── xl.meta
            └── metadata
                ├── 00000-f48245c1-6286-4db0-a99a-71d3ad588d18.metadata.json
                │   └── xl.meta
                ├── 15c808f4-b6f2-4aaf-bb81-f3e086c9ec76-m0.avro
                │   └── xl.meta
                └── snap-4395223083632140688-1-15c808f4-b6f2-4aaf-bb81-f3e086c9ec76.avro
                    └── xl.meta

```

These are all erasure-encoded minio files which is not meant for direct consumption. Instead we do `mc cp` to copy them into actual format.

```sh
docker exect -it mc bash
mc alias list
mc ls minio
mc cp --recursive minio/warehouse/ /data/warehouse
```

Now actual files are available under `minio-data`:

```
❯ tree
.
├── README.md
├── catalog
│   └── test.db
├── docker-compose.yml
├── minio-data
│   └── warehouse
│       └── nyc
│           └── taxis
│               ├── data
│               │   └── 00001-2-ea79ee2d-93f4-479e-97ba-d143cc40dbe1-0-00001.parquet
│               └── metadata
│                   ├── 00000-f48245c1-6286-4db0-a99a-71d3ad588d18.metadata.json
│                   ├── 15c808f4-b6f2-4aaf-bb81-f3e086c9ec76-m0.avro
│                   └── snap-4395223083632140688-1-15c808f4-b6f2-4aaf-bb81-f3e086c9ec76.avro
├── minio-raw
│   └── warehouse
│       └── nyc
│           └── taxis
│               ├── data
│               │   └── 00001-2-ea79ee2d-93f4-479e-97ba-d143cc40dbe1-0-00001.parquet
│               │       ├── d9dcc96b-569f-4fc0-8d42-3f4d70ea1da0
│               │       │   └── part.1
│               │       └── xl.meta
│               └── metadata
│                   ├── 00000-f48245c1-6286-4db0-a99a-71d3ad588d18.metadata.json
│                   │   └── xl.meta
│                   ├── 15c808f4-b6f2-4aaf-bb81-f3e086c9ec76-m0.avro
│                   │   └── xl.meta
│                   └── snap-4395223083632140688-1-15c808f4-b6f2-4aaf-bb81-f3e086c9ec76.avro
│                       └── xl.meta
├── notebooks
└── warehouse
```


Inspecting the metadata file that sqllite entry points to:

```
❯ cat metadata/00000-f48245c1-6286-4db0-a99a-71d3ad588d18.metadata.json | jq
{
  "format-version": 2,
  "table-uuid": "c58d5cdf-0570-41f8-aa65-f73c2ab7b162",
  "location": "s3://warehouse/nyc/taxis",
  "last-sequence-number": 1,
  "last-updated-ms": 1721447185053,
  "last-column-id": 19,
  "current-schema-id": 0,
  "schemas": [
    {
      "type": "struct",
      "schema-id": 0,
      "fields": [
        {
          "id": 1,
          "name": "VendorID",
          "required": false,
          "type": "long"
        },
        {
          "id": 2,
          "name": "tpep_pickup_datetime",
          "required": false,
          "type": "timestamp"
        },
        {
          "id": 3,
          "name": "tpep_dropoff_datetime",
          "required": false,
          "type": "timestamp"
        },
        {
          "id": 4,
          "name": "passenger_count",
          "required": false,
          "type": "double"
        },
        {
          "id": 5,
          "name": "trip_distance",
          "required": false,
          "type": "double"
        },
        {
          "id": 6,
          "name": "RatecodeID",
          "required": false,
          "type": "double"
        },
        {
          "id": 7,
          "name": "store_and_fwd_flag",
          "required": false,
          "type": "string"
        },
        {
          "id": 8,
          "name": "PULocationID",
          "required": false,
          "type": "long"
        },
        {
          "id": 9,
          "name": "DOLocationID",
          "required": false,
          "type": "long"
        },
        {
          "id": 10,
          "name": "payment_type",
          "required": false,
          "type": "long"
        },
        {
          "id": 11,
          "name": "fare_amount",
          "required": false,
          "type": "double"
        },
        {
          "id": 12,
          "name": "extra",
          "required": false,
          "type": "double"
        },
        {
          "id": 13,
          "name": "mta_tax",
          "required": false,
          "type": "double"
        },
        {
          "id": 14,
          "name": "tip_amount",
          "required": false,
          "type": "double"
        },
        {
          "id": 15,
          "name": "tolls_amount",
          "required": false,
          "type": "double"
        },
        {
          "id": 16,
          "name": "improvement_surcharge",
          "required": false,
          "type": "double"
        },
        {
          "id": 17,
          "name": "total_amount",
          "required": false,
          "type": "double"
        },
        {
          "id": 18,
          "name": "congestion_surcharge",
          "required": false,
          "type": "double"
        },
        {
          "id": 19,
          "name": "airport_fee",
          "required": false,
          "type": "double"
        }
      ]
    }
  ],
  "default-spec-id": 0,
  "partition-specs": [
    {
      "spec-id": 0,
      "fields": []
    }
  ],
  "last-partition-id": 999,
  "default-sort-order-id": 0,
  "sort-orders": [
    {
      "order-id": 0,
      "fields": []
    }
  ],
  "properties": {
    "owner": "root",
    "created-at": "2024-07-20T03:46:19.091434337Z",
    "write.format.default": "parquet",
    "write.parquet.compression-codec": "zstd"
  },
  "current-snapshot-id": 4395223083632141000,
  "refs": {
    "main": {
      "snapshot-id": 4395223083632141000,
      "type": "branch"
    }
  },
  "snapshots": [
    {
      "sequence-number": 1,
      "snapshot-id": 4395223083632141000,
      "timestamp-ms": 1721447185053,
      "summary": {
        "operation": "append",
        "spark.app.id": "local-1721447155551",
        "added-data-files": "1",
        "added-records": "2171187",
        "added-files-size": "33920189",
        "changed-partition-count": "1",
        "total-records": "2171187",
        "total-files-size": "33920189",
        "total-data-files": "1",
        "total-delete-files": "0",
        "total-position-deletes": "0",
        "total-equality-deletes": "0"
      },
      "manifest-list": "s3://warehouse/nyc/taxis/metadata/snap-4395223083632140688-1-15c808f4-b6f2-4aaf-bb81-f3e086c9ec76.avro",
      "schema-id": 0
    }
  ],
  "statistics": [],
  "partition-statistics": [],
  "snapshot-log": [
    {
      "timestamp-ms": 1721447185053,
      "snapshot-id": 4395223083632141000
    }
  ],
  "metadata-log": []
}
```

Current snapshot_id is `4395223083632141000` and it points to manifest-list which is stored as avro file:

```
❯ avro-tools tojson metadata/snap-4395223083632140688-1-15c808f4-b6f2-4aaf-bb81-f3e086c9ec76.avro | jq

{
  "manifest_path": "s3://warehouse/nyc/taxis/metadata/15c808f4-b6f2-4aaf-bb81-f3e086c9ec76-m0.avro",
  "manifest_length": 8178,
  "partition_spec_id": 0,
  "content": 0,
  "sequence_number": 1,
  "min_sequence_number": 1,
  "added_snapshot_id": 4395223083632141000,
  "added_files_count": 1,
  "existing_files_count": 0,
  "deleted_files_count": 0,
  "added_rows_count": 2171187,
  "existing_rows_count": 0,
  "deleted_rows_count": 0,
  "partitions": {
    "array": []
  }
}
```


Manifest List points to a manifest which is also stored as avro:

```
❯ avro-tools tojson metadata/15c808f4-b6f2-4aaf-bb81-f3e086c9ec76-m0.avro | jq

{
  "status": 1,
  "snapshot_id": {
    "long": 4395223083632141000
  },
  "sequence_number": null,
  "file_sequence_number": null,
  "data_file": {
    "content": 0,
    "file_path": "s3://warehouse/nyc/taxis/data/00001-2-ea79ee2d-93f4-479e-97ba-d143cc40dbe1-0-00001.parquet",
    "file_format": "PARQUET",
    "partition": {},
    "record_count": 2171187,
    "file_size_in_bytes": 33920189,
    "column_sizes": {
      "array": [
        {
          "key": 1,
          "value": 275145
        },
        ...
        {
          "key": 19,
          "value": 91937
        }
      ]
    },
    "value_counts": {
      "array": [
        {
          "key": 1,
          "value": 2171187
        },
        ...
        {
          "key": 19,
          "value": 2171187
        }
      ]
    },
    "null_value_counts": {
      "array": [
        {
          "key": 1,
          "value": 0
        },
        ...
        {
          "key": 19,
          "value": 128096
        }
      ]
    },
    "nan_value_counts": {
      "array": [
        {
          "key": 4,
          "value": 0
        },
        ...
        {
          "key": 19,
          "value": 0
        }
      ]
    },
    "lower_bounds": {
      "array": [
        {
          "key": 1,
          "value": "\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000"
        },
        ...
        {
          "key": 19,
          "value": "\u0000\u0000\u0000\u0000\u0000\u0000ô¿"
        }
      ]
    },
    "upper_bounds": {
      "array": [
        {
          "key": 1,
          "value": "\u0006\u0000\u0000\u0000\u0000\u0000\u0000\u0000"
        },
        ...
        {
          "key": 19,
          "value": "\u0000\u0000\u0000\u0000\u0000\u0000ô?"
        }
      ]
    },
    "key_metadata": null,
    "split_offsets": {
      "array": [
        4
      ]
    },
    "equality_ids": null,
    "sort_order_id": {
      "int": 0
    }
  }
}
```


Inspecting Parquet Data Files:

```
❯ cd minio-data/warehouse/nyc/taxis/
❯ parquet-read -n 2 --json data/00001-2-ea79ee2d-93f4-479e-97ba-d143cc40dbe1-0-00001.parquet | jq
{
  "DOLocationID": 116,
  "PULocationID": 79,
  "RatecodeID": 1,
  "VendorID": 1,
  "airport_fee": 0,
  "congestion_surcharge": 2.5,
  "extra": 3,
  "fare_amount": 25.5,
  "improvement_surcharge": 0.3,
  "mta_tax": 0.5,
  "passenger_count": 1,
  "payment_type": 1,
  "store_and_fwd_flag": "N",
  "tip_amount": 5.85,
  "tolls_amount": 0,
  "total_amount": 35.15,
  "tpep_dropoff_datetime": "2021-04-01 00:21:54 +00:00",
  "tpep_pickup_datetime": "2021-04-01 00:00:18 +00:00",
  "trip_distance": 8.4
}
{
  "DOLocationID": 236,
  "PULocationID": 75,
  "RatecodeID": 1,
  "VendorID": 1,
  "airport_fee": 0,
  "congestion_surcharge": 2.5,
  "extra": 3,
  "fare_amount": 5,
  "improvement_surcharge": 0.3,
  "mta_tax": 0.5,
  "passenger_count": 1,
  "payment_type": 2,
  "store_and_fwd_flag": "N",
  "tip_amount": 0,
  "tolls_amount": 0,
  "total_amount": 8.8,
  "tpep_dropoff_datetime": "2021-04-01 00:46:23 +00:00",
  "tpep_pickup_datetime": "2021-04-01 00:42:37 +00:00",
  "trip_distance": 0.9
}
```

## References
- https://tabular.io/blog/docker-spark-and-iceberg-the-fastest-way-to-try-iceberg/